name: Backend CI/CD

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_BACKEND: wumbo-backend
  ECR_REPOSITORY_MIGRATION: wumbo-migration
  ECS_CLUSTER: wumbo-cluster
  ECS_SERVICE_BACKEND: wumbo-backend
  ECS_SERVICE_WORKER: wumbo-worker
  ECS_SERVICE_BEAT: wumbo-beat

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: Run linting
        run: |
          pip install ruff
          ruff check .

      - name: Run tests
        run: |
          pytest tests/ -v --cov=app --cov-report=term-missing

  build-and-push:
    name: Build and Push to ECR
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      environment: ${{ steps.set-env.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine environment
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=development" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Extract metadata for Docker
        id: meta
        run: |
          ENV=${{ steps.set-env.outputs.environment }}
          TAG="${ENV}-${GITHUB_SHA::7}"
          echo "tags=${{ steps.login-ecr.outputs.registry }}/${ENV}-${ECR_REPOSITORY_BACKEND}:${TAG}" >> $GITHUB_OUTPUT
          echo "latest=${{ steps.login-ecr.outputs.registry }}/${ENV}-${ECR_REPOSITORY_BACKEND}:latest" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ steps.meta.outputs.tags }}
            ${{ steps.meta.outputs.latest }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push migration image (if needed)
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.migration
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ steps.set-env.outputs.environment }}-${{ env.ECR_REPOSITORY_MIGRATION }}:${{ steps.set-env.outputs.environment }}-${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/${{ steps.set-env.outputs.environment }}-${{ env.ECR_REPOSITORY_MIGRATION }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    environment:
      name: ${{ needs.build-and-push.outputs.environment }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Run database migrations
        run: |
          # TODO: Run Alembic migrations using ECS task
          # aws ecs run-task --cluster ... --task-definition migration ...
          echo "Database migrations would run here"

      - name: Deploy backend service
        run: |
          ENV=${{ needs.build-and-push.outputs.environment }}
          aws ecs update-service \
            --cluster ${ENV}-${ECS_CLUSTER} \
            --service ${ENV}-${ECS_SERVICE_BACKEND} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Deploy worker service
        run: |
          ENV=${{ needs.build-and-push.outputs.environment }}
          aws ecs update-service \
            --cluster ${ENV}-${ECS_CLUSTER} \
            --service ${ENV}-${ECS_SERVICE_WORKER} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Deploy beat service
        run: |
          ENV=${{ needs.build-and-push.outputs.environment }}
          aws ecs update-service \
            --cluster ${ENV}-${ECS_CLUSTER} \
            --service ${ENV}-${ECS_SERVICE_BEAT} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Wait for services to stabilize
        run: |
          ENV=${{ needs.build-and-push.outputs.environment }}

          echo "Waiting for backend service..."
          aws ecs wait services-stable \
            --cluster ${ENV}-${ECS_CLUSTER} \
            --services ${ENV}-${ECS_SERVICE_BACKEND} \
            --region ${{ env.AWS_REGION }}

          echo "Waiting for worker service..."
          aws ecs wait services-stable \
            --cluster ${ENV}-${ECS_CLUSTER} \
            --services ${ENV}-${ECS_SERVICE_WORKER} \
            --region ${{ env.AWS_REGION }}

          echo "Waiting for beat service..."
          aws ecs wait services-stable \
            --cluster ${ENV}-${ECS_CLUSTER} \
            --services ${ENV}-${ECS_SERVICE_BEAT} \
            --region ${{ env.AWS_REGION }}

          echo "All services deployed successfully!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ Deployment to ${{ needs.build-and-push.outputs.environment }} succeeded!"
          else
            echo "❌ Deployment to ${{ needs.build-and-push.outputs.environment }} failed!"
          fi
